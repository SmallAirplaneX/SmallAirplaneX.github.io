import{_ as re,r as i,j as ce,c,o as d,a as o,e as M,t as p,m as de,p as G,F as H,q as A,l as pe,v as ve,s as he}from"./index-DGVvU5mU.js";const me={class:"file-manager"},fe={class:"upload-section"},ye=["disabled"],we={class:"upload-status"},_e={key:1,class:"progress-container"},ge={class:"progress-bar"},ke={class:"progress-text"},be={key:2,class:"file-info"},$e={key:0,class:"download-links-section"},Ce={class:"copy-status"},Te={class:"download-links-list"},Ue={class:"link-info"},Fe={class:"link-filename"},Ne={class:"link-url"},Ie={class:"link-time"},xe=["onClick"],ze={class:"download-section"},Pe={class:"download-input"},Me={class:"download-status"},Se={class:"file-list-section"},Re={key:0,class:"loading-text"},Ee={key:1,class:"empty-text"},De={key:2,class:"file-list"},Be={class:"file-name"},Le={class:"file-size"},je={class:"file-type"},Oe=["onClick"],qe={__name:"Pan",setup(Ve){const b=i(null),r=i(null),s=i(""),l=i(0),h=i(!1),I=i([]),$=i(""),_=i(""),v=i(""),J=he(),x=i([]),S=i(!1),R=i([]),C=i(""),T=i(0),K=()=>{b.value?.click()},X=t=>{const e=t.target.files[0];e&&(r.value=e,s.value=`已选择文件: ${e.name}`)},Z=async()=>{if(!r.value){s.value="请先选择文件";return}const t=r.value,e=encodeURIComponent(t.name),a=10*1024*1024,n=Math.ceil(t.size/a);if(n===1){await Q(t,e);return}try{h.value=!0,s.value=`开始多部分上传，共 ${n} 个分片...`,l.value=0;const m=await fetch(`https://r2.buzhidao.net/${e}?action=mpu-create`,{method:"POST"});if(!m.ok)throw new Error(`创建上传会话失败: ${m.status}`);const{uploadId:u}=await m.json();$.value=u;const y=[],V=20,z=[];for(let w=0;w<n;w++){const U=I.value.find(f=>f.partNumber===w+1);if(U){y.push(U),T.value++;continue}const g=w*a,F=Math.min(g+a,t.size),P=t.slice(g,F),k=w+1;z.push({partNumber:k,chunk:P})}const E=new Set,D=[...z];await new Promise((w,U)=>{let g=0,F=!1;const P=async()=>{if(F||g===z.length){g===z.length&&w();return}for(;D.length>0&&E.size<V&&!F;){if(!h.value){U(new Error("上传已取消"));return}const k=D.shift(),{partNumber:f,chunk:ie}=k;E.add(f),(async()=>{try{s.value=`上传分片 ${f}/${n}...`;const N=await fetch(`https://r2.buzhidao.net/${e}?action=mpu-uploadpart&uploadId=${u}&partNumber=${f}`,{method:"PUT",body:ie,headers:{"Content-Type":"application/octet-stream"}});if(!N.ok)throw new Error(`上传分片 ${f} 失败: ${N.status}`);const L=await N.json();return y.push(L),I.value.push(L),T.value++,l.value=Math.round(T.value/n*100),s.value=`上传进度: ${l.value}% (${T.value}/${n})`,L}catch(N){return F=!0,U(new Error(`分片 ${f} 上传失败: ${N.message}`)),null}finally{E.delete(f),g++,P()}})()}};for(let k=0;k<Math.min(V,D.length);k++)P()});const B=await fetch(`https://r2.buzhidao.net/${e}?action=mpu-complete&uploadId=${u}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({parts:y,contentType:t.type||"application/octet-stream"})});if(!B.ok)throw new Error(`完成上传失败: ${B.status}`);const le=await B.json();s.value="多部分上传完成！",l.value=100;const ue=`https://r2.buzhidao.net/${e}?download=true`;R.value.unshift({filename:t.name,url:ue,timestamp:new Date,contentType:le.contentType}),r.value=null,b.value.value="",I.value=[],$.value=""}catch(m){s.value=`上传错误: ${m.message}`,l.value=0}finally{h.value=!1}},Q=async(t,e)=>{const a=`https://r2.buzhidao.net/${e}`;return h.value=!0,s.value="开始上传小文件...",l.value=0,new Promise((n,m)=>{const u=new XMLHttpRequest;u.open("PUT",a,!0),u.setRequestHeader("Content-Type",t.type),u.upload.onprogress=y=>{y.lengthComputable&&(l.value=Math.round(y.loaded/y.total*100),s.value=`上传进度: ${l.value}%`)},u.onload=()=>{u.status>=200&&u.status<300?(s.value="上传成功！",l.value=100,r.value=null,b.value.value="",n()):(s.value=`上传失败: ${u.status} ${u.statusText}`,l.value=0,m(new Error(u.statusText)))},u.onerror=()=>{s.value="上传错误: 网络问题",l.value=0,m(new Error("Network error"))},u.send(t)}).finally(()=>{h.value=!1})},j=(t,e)=>{const a=document.createElement("a");a.href=t,a.download=e,a.style.display="none",document.body.appendChild(a),a.click(),document.body.removeChild(a)},W=async()=>{if(!_.value){v.value="请输入要下载的文件名";return}try{v.value="准备下载...";const e=`https://r2.buzhidao.net/${encodeURIComponent(_.value)}?download=true`;j(e,_.value),v.value="下载已开始！",setTimeout(()=>{v.value=""},3e3)}catch(t){v.value=`下载错误: ${t.message}`}},O=async t=>{try{v.value="准备下载...";const a=`https://r2.buzhidao.net/${encodeURIComponent(t)}?download=true`;j(a,t),v.value="下载已开始！",setTimeout(()=>{v.value=""},3e3)}catch(e){v.value=`下载错误: ${e.message}`}},Y=async()=>{await ne(),h.value=!1,s.value="上传已取消",l.value=0},q=t=>{if(t===0)return"0 B";const e=1024,a=["B","KB","MB","GB","TB"],n=Math.floor(Math.log(t)/Math.log(e));return parseFloat((t/Math.pow(e,n)).toFixed(2))+" "+a[n]},ee=t=>t?{"image/png":"PNG Image","image/jpeg":"JPEG Image","application/pdf":"PDF Document","text/plain":"Text File","application/octet-stream":"Binary File"}[t]||t.split("/").pop().toUpperCase():"--",te=t=>new Date(t).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}),ae=async(t=null)=>{try{S.value=!0;let e="https://r2.buzhidao.net/?action=list";t&&(e+=`&cursor=${encodeURIComponent(t)}`);const n=await(await fetch(e)).json();x.value=[...x.value,...n.files||[]],n.truncated&&n.cursor}catch(e){console.error("获取文件列表错误:",e),v.value="网络错误，无法获取文件列表"}finally{S.value=!1}},oe=()=>{const t=J.query.download?.toString();t&&(_.value=t,setTimeout(()=>{O(t)},100))},se=async t=>{try{await navigator.clipboard.writeText(t),C.value="链接已复制到剪贴板！",setTimeout(()=>{C.value=""},2e3)}catch{C.value="复制失败，请手动复制链接",setTimeout(()=>{C.value=""},2e3)}},ne=async()=>{if(!r.value||!$.value){s.value="没有正在进行的上传或缺少 uploadId";return}try{h.value=!1,s.value="正在中止上传...",l.value=0;const t=encodeURIComponent(r.value.name),e=await fetch(`https://r2.buzhidao.net/${t}?action=mpu-abort&uploadId=${$.value}`,{method:"POST",headers:{"Content-Type":"application/json"}});if(!e.ok)throw new Error(`中止上传失败: ${e.status}`);const a=await e.json();s.value=a.message||"上传已中止！",r.value=null,b.value.value="",I.value=[],$.value="",T.value=0}catch(t){s.value=`中止上传错误: ${t.message}`}};return ce(()=>{oe(),ae()}),(t,e)=>(d(),c("div",me,[e[6]||(e[6]=o("h2",null,"文件上传下载管理器",-1)),o("div",fe,[e[3]||(e[3]=o("h3",null,"文件上传",-1)),o("input",{ref_key:"fileInput",ref:b,type:"file",style:{display:"none"},onChange:X},null,544),o("button",{onClick:K,class:"btn btn-primary"},"选择文件"),o("button",{onClick:Z,class:"btn btn-primary",disabled:!r.value||h.value}," 上传文件 ",8,ye),h.value?(d(),c("button",{key:0,onClick:Y,class:"btn btn-danger"}," 取消上传 ")):M("",!0),o("div",we,p(s.value),1),h.value?(d(),c("div",_e,[o("div",ge,[o("div",{class:"progress-fill",style:de({width:l.value+"%"})},null,4)]),o("div",ke,p(l.value)+"%",1)])):M("",!0),r.value?(d(),c("div",be,[G(" 文件名: "+p(r.value.name),1),e[2]||(e[2]=o("br",null,null,-1)),G(" 大小: "+p(q(r.value.size))+" ",1),R.value.length>0?(d(),c("div",$e,[e[1]||(e[1]=o("h4",null,"最近上传的文件链接",-1)),o("div",Ce,p(C.value),1),o("ul",Te,[(d(!0),c(H,null,A(R.value,(a,n)=>(d(),c("li",{key:n,class:"download-link-item"},[o("div",Ue,[o("span",Fe,p(a.filename),1),o("span",Ne,p(a.url),1),o("span",Ie,p(te(a.timestamp)),1)]),o("button",{onClick:m=>se(a.url),class:"btn btn-small btn-secondary"}," 复制链接 ",8,xe)]))),128))])])):M("",!0)])):M("",!0)]),o("div",ze,[e[5]||(e[5]=o("h3",null,"文件下载",-1)),o("div",Pe,[pe(o("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>_.value=a),type:"text",placeholder:"输入要下载的文件名",class:"input-field"},null,512),[[ve,_.value]]),o("button",{onClick:W,class:"btn btn-primary"},"下载文件")]),o("div",Me,p(v.value),1),o("div",Se,[e[4]||(e[4]=o("h4",null,"可下载文件列表",-1)),S.value?(d(),c("div",Re," 正在加载文件列表... ")):x.value.length===0?(d(),c("div",Ee,"暂无文件")):(d(),c("ul",De,[(d(!0),c(H,null,A(x.value,a=>(d(),c("li",{key:a.key,class:"file-item"},[o("span",Be,p(decodeURIComponent(a.key)),1),o("span",Le,p(q(a.size)),1),o("span",je,p(ee(a.contentType)),1),o("button",{onClick:n=>O(decodeURIComponent(a.key)),class:"btn btn-small"}," 下载 ",8,Oe)]))),128))]))])])]))}},Je=re(qe,[["__scopeId","data-v-911aeb4c"]]);export{Je as default};
